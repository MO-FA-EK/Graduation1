<div class="dashboard-container">
  <button class="mobile-menu-btn" (click)="toggleSidebar()">â˜° Menu</button>

  <aside class="sidebar" [class.open]="isSidebarOpen">
    <h3>{{ isClient ? 'Client Area' : 'Freelancer Panel' }}</h3>
    <nav>
      <button [class.active]="activeTab === 'projects'" (click)="setTab('projects')">ğŸš€ {{ isClient ? 'Hired Projects' : 'My Jobs' }}</button>
      <button [class.active]="activeTab === 'profile'" (click)="setTab('profile')">ğŸ‘¤ Profile</button>
      <button *ngIf="!isClient" [class.active]="activeTab === 'stats'" (click)="setTab('stats')">ğŸ“Š Stats</button>
      <button *ngIf="!isClient" [class.active]="activeTab === 'ratings'" (click)="setTab('ratings')">â­ Ratings</button>
      <button [class.active]="activeTab === 'security'" (click)="setTab('security')">ğŸ”’ Security</button>
      <button class="logout-btn" (click)="logout()">ğŸšª Logout</button>
    </nav>
  </aside>

  <section class="content">
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading Dashboard...</p>
    </div>

    <div *ngIf="!isLoading && profile; else noProfile">

      <div *ngIf="activeTab === 'projects'" class="tab-content fade-in">
        <h2>{{ isClient ? 'Projects You Hired' : 'Active Jobs' }}</h2>

        <div *ngIf="isClient">
          <div *ngIf="hiredProjects && hiredProjects.length > 0; else noHired">
            <div *ngFor="let p of hiredProjects" class="project-card">
              <div class="card-header">
                <h4>{{ p.title }}</h4> <span class="status-badge" [class]="p.status">{{ p.status }}</span>
              </div>

              <div *ngIf="!p.is_paid && p.status !== 'cancelled'" class="payment-alert">
                <span>âš ï¸ Payment Pending (${{ p.amount }})</span>
                <button class="pay-btn" (click)="openPaymentModal(p)">ğŸ’³ Pay Now</button>
              </div>

              <p>Freelancer: {{ p.freelancer_name }}</p>
              <p><strong>Price:</strong> ${{ p.amount }}</p>
              <p>{{ p.description }}</p>
              <p *ngIf="p.document" class="doc-link">
                <a [href]="p.document" target="_blank" download>ğŸ“„ Download Project Document</a>
              </p>
              <div class="github-box">
                <a *ngIf="p.github_link" [href]="p.github_link" target="_blank">{{ p.github_link }}</a>
                <span *ngIf="!p.github_link">Waiting for link...</span>
                <button *ngIf="p.github_link" class="track-btn" (click)="viewCommits(p)">ğŸ” Track Progress</button>
              </div>
            </div>
          </div>
          <ng-template #noHired>
            <div class="empty-state">
              <span class="empty-icon">ğŸ“‚</span>
              <p>No projects yet.</p>
              <button routerLink="/services" class="cta-btn">Find Talent</button>
            </div>
          </ng-template>
        </div>

        <div *ngIf="!isClient">
          
          <h3>Pending Requests</h3>
          <div *ngIf="workProjects | filterStatus:'pending' as pendingList">
            <div *ngIf="pendingList.length > 0; else noPending">
              <div *ngFor="let p of pendingList" class="project-card pending-card">
                 <div class="card-header">
                    <h4>{{ p.title }}</h4> <span class="badge pending">Pending Approval</span>
                 </div>
                 <p><strong>Client:</strong> {{ p.client_name }}</p>
                 <p><strong>Offer:</strong> ${{ p.amount }}</p>
                 <p *ngIf="p.document" class="doc-link">
                    <a [href]="p.document" target="_blank" download>ğŸ“„ Project Document</a>
                 </p>
                  <p class="desc">{{ p.description }}</p>
                 <div class="actions">
                     <button class="accept-btn" (click)="acceptProject(p)">âœ… Accept</button>
                     <button class="reject-btn" (click)="rejectProject(p)">âŒ Reject</button>
                 </div>
              </div>
            </div>
            <ng-template #noPending><p>No pending requests.</p></ng-template>
          </div>

          <hr class="divider">

          <h3>Active Jobs</h3>
          <div *ngIf="workProjects | filterStatus:'active' as activeList">
             <div *ngIf="activeList.length > 0; else noActive">
                <div *ngFor="let p of activeList" class="project-card">
                   <div class="card-header">
                      <h4>{{ p.title }}</h4> <span class="badge active">In Progress</span>
                   </div>
                   <div *ngIf="!p.is_paid" class="unpaid-badge">ğŸ’° Waiting for Payment</div>
                   <div *ngIf="p.is_paid" class="paid-badge">âœ… Paid</div>
                   
                   <p><strong>Client:</strong> {{ p.client_name }}</p>
                   <p><strong>Price:</strong> ${{ p.amount }}</p>
                   <p *ngIf="p.document" class="doc-link">
                      <a [href]="p.document" target="_blank" download>ğŸ“„ Download Project Document</a>
                   </p>
                   <div class="github-box">
                      <input [(ngModel)]="p.github_link" placeholder="GitHub Link">
                      <button (click)="updateProject(p)">Save Link</button>
                   </div>
                   
                    <div style="margin-top: 15px;">
                       <button class="complete-btn" (click)="completeProject(p)">ğŸ‰ Mark as Completed</button>
                    </div>

                </div>
             </div>
             <ng-template #noActive><p>No active jobs.</p></ng-template>
          </div>

          <hr class="divider">

          <h3>Completed Projects</h3>
          <div *ngIf="completedProjects && completedProjects.length > 0; else noCompleted">
            <div *ngFor="let p of completedProjects" class="project-card completed-card">
                 <div class="card-header">
                    <h4>{{ p.title }}</h4> <span class="badge completed">Completed</span>
                 </div>
                 <p><strong>Client:</strong> {{ p.client_name }}</p>
                 <p><strong>Price:</strong> ${{ p.amount }}</p>
                 <p>âœ… Provide amazing work!</p>
            </div>
          </div>
          <ng-template #noCompleted><p>No completed projects yet.</p></ng-template>

        </div>
      </div>

      <div *ngIf="activeTab === 'profile'" class="tab-content fade-in">
        <h2>Edit Profile</h2>
        <div class="form-grid">
          <div class="form-group"><label>Username</label><input [(ngModel)]="profile.username"></div>
          <ng-container *ngIf="!isClient">
            <div class="form-group"><label>Category</label><input [(ngModel)]="profile.category"></div>
            <div class="form-group full-width"><label>Description</label><textarea [(ngModel)]="profile.description"></textarea></div>
            <div class="form-group full-width"><label>Skills</label><input [(ngModel)]="profile.skills"></div>
            <div class="form-group full-width"><label>Portfolio URL</label><input [(ngModel)]="profile.portfolio" placeholder="https://github.com/my-profile"></div>
            <div class="form-group full-width"><label>Image</label><input [(ngModel)]="profile.imageUrl"></div>
            <div class="form-group"><label>Bank Name</label><input [(ngModel)]="profile.bank_name" placeholder="Bank Name"></div>
            <div class="form-group"><label>IBAN / Account No</label><input [(ngModel)]="profile.iban" placeholder="IBAN"></div>
          </ng-container>
        </div>
        <button class="save-btn" (click)="saveProfile()">Save</button>
      </div>

      <div *ngIf="activeTab === 'security'" class="tab-content fade-in">
         <h2>Security</h2>
         <div class="form-grid">
            <input type="password" [(ngModel)]="passData.old_password" placeholder="Old Password">
            <input type="password" [(ngModel)]="passData.new_password" placeholder="New Password">
            <input type="password" [(ngModel)]="passData.confirm_password" placeholder="Confirm">
         </div>
         <button class="save-btn" (click)="changePasswordSubmit()">Update</button>
      </div>

      <div *ngIf="activeTab === 'stats' && !isClient" class="tab-content fade-in">
        <h2>Your Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card"><h3>ğŸ‘ï¸ Views</h3><p class="stat-value">{{ profile.profileViews || 0 }}</p></div>
          <div class="stat-card"><h3>ğŸ“© Clicks</h3><p class="stat-value">{{ profile.contactClicks || 0 }}</p></div>
          <div class="stat-card"><h3>â­ Rating</h3><p class="stat-value">{{ profile.rating || 0 }}</p></div>
        </div>
      </div>

      <div *ngIf="activeTab === 'ratings' && !isClient" class="tab-content fade-in">
        <h2>Reviews</h2>
        <div class="rating-summary">
          <span class="big-star">â­</span>
          <span class="rating-number">{{ profile.rating || 0 }}</span>
          <span class="rating-count">({{ profile.totalRatings || 0 }} reviews)</span>
        </div>
      </div>

    </div>
    <ng-template #noProfile><button (click)="logout()">Login Again</button></ng-template>
  </section>

  <div class="overlay" *ngIf="isSidebarOpen" (click)="toggleSidebar()"></div>

  <div class="overlay" *ngIf="showPaymentModal" style="display:flex;">
    <div class="payment-modal fade-in" style="width: 100%; max-width: 500px;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Complete Payment</h3>
        <button (click)="closePaymentModal()" style="background:none; border:none; font-size: 1.5rem; color: #666; cursor: pointer;">&times;</button>
      </div>

      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <p style="margin: 0; color: #555;">Project: <strong>{{ selectedProjectForPayment?.title }}</strong></p>
        <p style="margin: 5px 0 0; font-size: 1.2rem; color: #090979; font-weight: bold;">
          ${{ selectedProjectForPayment?.amount }}
        </p>
      </div>

      <div *ngIf="elementsOptions.clientSecret">
        <ngx-stripe-payment [options]="paymentElementOptions" [elementsOptions]="elementsOptions"></ngx-stripe-payment>
      </div>

      <div class="modal-actions" style="margin-top: 20px;">
        <button class="confirm-btn" [disabled]="isProcessingPayment" (click)="payNow()" style="width: 100%; padding: 12px; font-size: 1rem;">
          {{ isProcessingPayment ? 'Processing...' : 'Pay Now' }}
        </button>
      </div>

    </div>
  </div>

  <div class="overlay" *ngIf="showCommitsModal" style="display:flex;">
    <div class="commits-modal fade-in">
      <h3>Project Activity: {{ selectedProjectForCommits?.title }}</h3>
      <div *ngIf="isLoadingCommits" class="spinner-small"></div>
      
      <div *ngIf="!isLoadingCommits && commits.length === 0">
        <p>No commits found or private repository.</p>
      </div>

      <ul *ngIf="!isLoadingCommits && commits.length > 0" class="commit-list">
        <li *ngFor="let c of commits">
          <div class="commit-msg">{{ c.commit.message }}</div>
          <div class="commit-meta">
            <span>ğŸ‘¤ {{ c.commit.author.name }}</span>
            <span>ğŸ•’ {{ c.commit.author.date | date:'short' }}</span>
          </div>
        </li>
      </ul>

      <button class="close-btn" (click)="closeCommitsModal()">Close</button>
    </div>
  </div>
</div>