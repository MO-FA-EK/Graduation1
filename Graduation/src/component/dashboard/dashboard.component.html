<div class="dashboard-container">
  <button class="mobile-menu-btn" (click)="toggleSidebar()">‚ò∞ Menu</button>

  <aside class="sidebar" [class.open]="isSidebarOpen">
    <h3>{{ isClient ? 'Client Area' : 'Freelancer Panel' }}</h3>
    <nav>
      <button [class.active]="activeTab === 'projects'" (click)="setTab('projects')">üöÄ {{ isClient ? 'Hired Projects' : 'My Jobs' }}</button>
      <button [class.active]="activeTab === 'profile'" (click)="setTab('profile')">üë§ Profile</button>
      <button *ngIf="!isClient" [class.active]="activeTab === 'stats'" (click)="setTab('stats')">üìä Stats</button>
      <button *ngIf="!isClient" [class.active]="activeTab === 'ratings'" (click)="setTab('ratings')">‚≠ê Ratings</button>
      <button [class.active]="activeTab === 'security'" (click)="setTab('security')">üîí Security</button>
      <button class="logout-btn" (click)="logout()">üö™ Logout</button>
    </nav>
  </aside>

  <section class="content">
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading Dashboard...</p>
    </div>

    <div *ngIf="!isLoading && profile; else noProfile">

      <div *ngIf="activeTab === 'projects'" class="tab-content fade-in">
        <h2>{{ isClient ? 'Projects You Hired' : 'Active Jobs' }}</h2>

        <div *ngIf="isClient">
          <div *ngIf="hiredProjects && hiredProjects.length > 0; else noHired">
            <div *ngFor="let p of hiredProjects" class="project-card">
              <div class="card-header">
                <h4>{{ p.title }}</h4> <span class="status-badge" [class]="p.status">{{ p.status }}</span>
              </div>

              <div *ngIf="!p.is_paid && p.status !== 'cancelled'" class="payment-alert">
                <span>‚ö†Ô∏è Payment Pending ($50.00)</span>
                <button class="pay-btn" (click)="openPaymentModal(p)">üí≥ Pay Now</button>
              </div>

              <p>Freelancer: {{ p.freelancer_name }}</p>
              <p><strong>Price:</strong> ${{ p.amount }}</p>
              <p>{{ p.description }}</p>
              <div class="github-box">
                <a *ngIf="p.github_link" [href]="p.github_link" target="_blank">{{ p.github_link }}</a>
                <span *ngIf="!p.github_link">Waiting for link...</span>
              </div>
            </div>
          </div>
          <ng-template #noHired>
            <div class="empty-state">
              <span class="empty-icon">üìÇ</span>
              <p>No projects yet.</p>
              <button routerLink="/services" class="cta-btn">Find Talent</button>
            </div>
          </ng-template>
        </div>

        <div *ngIf="!isClient">
          
          <!-- Pending Requests -->
          <h3>Pending Requests</h3>
          <div *ngIf="workProjects | filterStatus:'pending' as pendingList">
            <div *ngIf="pendingList.length > 0; else noPending">
              <div *ngFor="let p of pendingList" class="project-card pending-card">
                 <div class="card-header">
                    <h4>{{ p.title }}</h4> <span class="badge pending">Pending Approval</span>
                 </div>
                 <p><strong>Client:</strong> {{ p.client_name }}</p>
                 <p><strong>Offer:</strong> ${{ p.amount }}</p>
                 <p class="desc">{{ p.description }}</p>
                 <button class="accept-btn" (click)="acceptProject(p)">‚úÖ Accept Project</button>
              </div>
            </div>
            <ng-template #noPending><p>No pending requests.</p></ng-template>
          </div>

          <hr class="divider">

          <!-- Active Jobs -->
          <h3>Active Jobs</h3>
          <div *ngIf="workProjects | filterStatus:'active' as activeList">
             <div *ngIf="activeList.length > 0; else noActive">
                <div *ngFor="let p of activeList" class="project-card">
                   <div class="card-header">
                      <h4>{{ p.title }}</h4> <span class="badge active">In Progress</span>
                   </div>
                   <div *ngIf="!p.is_paid" class="unpaid-badge">üí∞ Waitting for Payment</div>
                   <div *ngIf="p.is_paid" class="paid-badge">‚úÖ Paid</div>
                   
                   <p><strong>Client:</strong> {{ p.client_name }}</p>
                   <p><strong>Price:</strong> ${{ p.amount }}</p>
                   <div class="github-box">
                      <input [(ngModel)]="p.github_link" placeholder="GitHub Link">
                      <button (click)="updateProject(p)">Save Link</button>
                   </div>
                </div>
             </div>
             <ng-template #noActive><p>No active jobs.</p></ng-template>
          </div>

        </div>
      </div>

      <div *ngIf="activeTab === 'profile'" class="tab-content fade-in">
        <h2>Edit Profile</h2>
        <div class="form-grid">
          <div class="form-group"><label>Username</label><input [(ngModel)]="profile.username"></div>
          <ng-container *ngIf="!isClient">
            <div class="form-group"><label>Category</label><input [(ngModel)]="profile.category"></div>
            <div class="form-group full-width"><label>Bio</label><textarea [(ngModel)]="profile.description"></textarea></div>
            <div class="form-group full-width"><label>Skills</label><input [(ngModel)]="profile.skills"></div>
            <div class="form-group full-width"><label>Portfolio URL</label><input [(ngModel)]="profile.portfolio" placeholder="https://github.com/my-profile"></div>
            <div class="form-group full-width"><label>Image</label><input [(ngModel)]="profile.imageUrl"></div>
            <div class="form-group"><label>Bank Name</label><input [(ngModel)]="profile.bank_name" placeholder="Bank Name"></div>
            <div class="form-group"><label>IBAN / Account No</label><input [(ngModel)]="profile.iban" placeholder="IBAN"></div>
          </ng-container>
        </div>
        <button class="save-btn" (click)="saveProfile()">Save</button>
      </div>

      <div *ngIf="activeTab === 'security'" class="tab-content fade-in">
         <h2>Security</h2>
         <div class="form-grid">
            <input type="password" [(ngModel)]="passData.old_password" placeholder="Old Password">
            <input type="password" [(ngModel)]="passData.new_password" placeholder="New Password">
            <input type="password" [(ngModel)]="passData.confirm_password" placeholder="Confirm">
         </div>
         <button class="save-btn" (click)="changePasswordSubmit()">Update</button>
      </div>

      <div *ngIf="activeTab === 'stats' && !isClient" class="tab-content fade-in">
        <h2>Your Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card"><h3>üëÅÔ∏è Views</h3><p class="stat-value">{{ profile.profileViews || 0 }}</p></div>
          <div class="stat-card"><h3>üì© Clicks</h3><p class="stat-value">{{ profile.contactClicks || 0 }}</p></div>
          <div class="stat-card"><h3>‚≠ê Rating</h3><p class="stat-value">{{ profile.rating || 0 }}</p></div>
        </div>
      </div>

      <div *ngIf="activeTab === 'ratings' && !isClient" class="tab-content fade-in">
        <h2>Reviews</h2>
        <div class="rating-summary">
          <span class="big-star">‚≠ê</span>
          <span class="rating-number">{{ profile.rating || 0 }}</span>
          <span class="rating-count">({{ profile.totalRatings || 0 }} reviews)</span>
        </div>
      </div>

    </div>
    <ng-template #noProfile><button (click)="logout()">Login Again</button></ng-template>
  </section>

  <div class="overlay" *ngIf="isSidebarOpen" (click)="toggleSidebar()"></div>

  <div class="overlay" *ngIf="showPaymentModal" style="display:flex;">
    <div class="payment-modal fade-in">
      <h3>Secure Payment</h3>
      <p>Pay <strong>$50.00</strong> for project "{{ selectedProjectForPayment?.title }}"</p>

      <div class="stripe-box">
        <ngx-stripe-card [options]="cardOptions" [elementsOptions]="elementsOptions"></ngx-stripe-card>
      </div>

      <div class="modal-actions">
        <button class="cancel-btn" (click)="closePaymentModal()">Cancel</button>
        <button class="confirm-btn" [disabled]="isProcessingPayment" (click)="payNow()">
          {{ isProcessingPayment ? 'Processing...' : 'Pay Now' }}
        </button>
      </div>
    </div>
  </div>
</div>
