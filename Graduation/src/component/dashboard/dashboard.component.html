<div class="dashboard-container">
  <button class="mobile-menu-btn" (click)="toggleSidebar()">â˜° Menu</button>

  <aside class="sidebar" [class.open]="isSidebarOpen">
    <h3>{{ isClient ? 'Client Area' : 'Freelancer Panel' }}</h3>
    <nav>
      <button [class.active]="activeTab === 'projects'" (click)="setTab('projects')">ğŸš€ {{ isClient ? 'Hired Projects' : 'My Jobs' }}</button>
      <button [class.active]="activeTab === 'profile'" (click)="setTab('profile')">ğŸ‘¤ Profile</button>
      <button *ngIf="!isClient" [class.active]="activeTab === 'stats'" (click)="setTab('stats')">ğŸ“Š Stats</button>
      <button *ngIf="!isClient" [class.active]="activeTab === 'ratings'" (click)="setTab('ratings')">â­ Ratings</button>
      <button [class.active]="activeTab === 'security'" (click)="setTab('security')">ğŸ”’ Security</button>
      <button class="logout-btn" (click)="logout()">ğŸšª Logout</button>
    </nav>
  </aside>

  <section class="content">
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading Dashboard...</p>
    </div>

    <div *ngIf="!isLoading && profile; else noProfile">

      <div *ngIf="activeTab === 'projects'" class="tab-content fade-in">
        <h2>{{ isClient ? 'Projects You Hired' : 'Active Jobs' }}</h2>

        <div *ngIf="isClient">
          <div *ngIf="hiredProjects && hiredProjects.length > 0; else noHired">
            <div *ngFor="let p of hiredProjects" class="project-card">
              <div class="card-header">
                <h4>{{ p.title }}</h4> <span class="status-badge" [class]="p.status">{{ p.status }}</span>
              </div>

              <div *ngIf="!p.is_paid && p.status !== 'cancelled'" class="payment-alert">
                <span>âš ï¸ Payment Pending ($50.00)</span>
                <button class="pay-btn" (click)="openPaymentModal(p)">ğŸ’³ Pay Now</button>
              </div>

              <p>Freelancer: {{ p.freelancer_name }}</p>
              <p>{{ p.description }}</p>
              <div class="github-box">
                <a *ngIf="p.github_link" [href]="p.github_link" target="_blank">{{ p.github_link }}</a>
                <span *ngIf="!p.github_link">Waiting for link...</span>
              </div>
            </div>
          </div>
          <ng-template #noHired>
            <div class="empty-state">
              <span class="empty-icon">ğŸ“‚</span>
              <p>No projects yet.</p>
              <button routerLink="/services" class="cta-btn">Find Talent</button>
            </div>
          </ng-template>
        </div>

        <div *ngIf="!isClient">
          <div *ngIf="workProjects && workProjects.length > 0; else noWork">
            <div *ngFor="let p of workProjects" class="project-card">
              <div class="card-header">
                <h4>{{ p.title }}</h4>
                <select [(ngModel)]="p.status"><option value="pending">Pending</option><option value="active">Active</option><option value="completed">Done</option></select>
              </div>
              <div *ngIf="!p.is_paid" class="unpaid-badge">ğŸ’° Client hasn't paid yet</div>
              <p>Client: {{ p.client_name }}</p>
              <div class="github-box">
                <input [(ngModel)]="p.github_link" placeholder="GitHub Link">
                <button (click)="updateProject(p)">Save</button>
              </div>
            </div>
          </div>
          <ng-template #noWork><p>No active jobs.</p></ng-template>
        </div>
      </div>

      <div *ngIf="activeTab === 'profile'" class="tab-content fade-in">
        <h2>Edit Profile</h2>
        <div class="form-grid">
          <div class="form-group"><label>Username</label><input [(ngModel)]="profile.username"></div>
          <ng-container *ngIf="!isClient">
            <div class="form-group"><label>Category</label><input [(ngModel)]="profile.category"></div>
            <div class="form-group full-width"><label>Bio</label><textarea [(ngModel)]="profile.description"></textarea></div>
            <div class="form-group full-width"><label>Skills</label><input [(ngModel)]="profile.skills"></div>
            <div class="form-group full-width"><label>Portfolio URL</label><input [(ngModel)]="profile.portfolio" placeholder="https://github.com/my-profile"></div>
            <div class="form-group full-width"><label>Image</label><input [(ngModel)]="profile.imageUrl"></div>
          </ng-container>
        </div>
        <button class="save-btn" (click)="saveProfile()">Save</button>
      </div>

      <div *ngIf="activeTab === 'security'" class="tab-content fade-in">
         <h2>Security</h2>
         <div class="form-grid">
            <input type="password" [(ngModel)]="passData.old_password" placeholder="Old Password">
            <input type="password" [(ngModel)]="passData.new_password" placeholder="New Password">
            <input type="password" [(ngModel)]="passData.confirm_password" placeholder="Confirm">
         </div>
         <button class="save-btn" (click)="changePasswordSubmit()">Update</button>
      </div>

      <div *ngIf="activeTab === 'stats' && !isClient" class="tab-content fade-in">
        <h2>Your Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card"><h3>ğŸ‘ï¸ Views</h3><p class="stat-value">{{ profile.profileViews || 0 }}</p></div>
          <div class="stat-card"><h3>ğŸ“© Clicks</h3><p class="stat-value">{{ profile.contactClicks || 0 }}</p></div>
          <div class="stat-card"><h3>â­ Rating</h3><p class="stat-value">{{ profile.rating || 0 }}</p></div>
        </div>
      </div>

      <div *ngIf="activeTab === 'ratings' && !isClient" class="tab-content fade-in">
        <h2>Reviews</h2>
        <div class="rating-summary">
          <span class="big-star">â­</span>
          <span class="rating-number">{{ profile.rating || 0 }}</span>
          <span class="rating-count">({{ profile.totalRatings || 0 }} reviews)</span>
        </div>
      </div>

    </div>
    <ng-template #noProfile><button (click)="logout()">Login Again</button></ng-template>
  </section>

  <div class="overlay" *ngIf="isSidebarOpen" (click)="toggleSidebar()"></div>

  <div class="overlay" *ngIf="showPaymentModal" style="display:flex;">
    <div class="payment-modal fade-in">
      <h3>Secure Payment</h3>
      <p>Pay <strong>$50.00</strong> for project "{{ selectedProjectForPayment?.title }}"</p>

      <div class="stripe-box">
        <ngx-stripe-card [options]="cardOptions" [elementsOptions]="elementsOptions"></ngx-stripe-card>
      </div>

      <div class="modal-actions">
        <button class="cancel-btn" (click)="closePaymentModal()">Cancel</button>
        <button class="confirm-btn" [disabled]="isProcessingPayment" (click)="payNow()">
          {{ isProcessingPayment ? 'Processing...' : 'Pay Now' }}
        </button>
      </div>
    </div>
  </div>
</div>
